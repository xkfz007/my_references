<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FFmpeg: libavcodec/aaccoder_twoloop.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FFmpeg
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_3b1f69f89eda39a44baf4887988d54a7.html">libavcodec</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">aaccoder_twoloop.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>AAC encoder twoloop coder.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;<a class="el" href="float_8h_source.html">float.h</a>&gt;</code><br />
<code>#include &quot;<a class="el" href="mathematics_8h_source.html">libavutil/mathematics.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mathops_8h_source.html">mathops.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="avcodec_8h_source.html">avcodec.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="put__bits_8h_source.html">put_bits.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="aac_8h_source.html">aac.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="aacenc_8h_source.html">aacenc.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="aactab_8h_source.html">aactab.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="aacenctab_8h_source.html">aacenctab.h</a>&quot;</code><br />
</div>
<p><a href="aaccoder__twoloop_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:af3b33fe7bf17f011bcec0708f8e679f9"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aaccoder__twoloop_8h.html#af3b33fe7bf17f011bcec0708f8e679f9">NOISE_LOW_LIMIT</a>&#160;&#160;&#160;4000</td></tr>
<tr class="memdesc:af3b33fe7bf17f011bcec0708f8e679f9"><td class="mdescLeft">&#160;</td><td class="mdescRight">This file contains a template for the twoloop coder function.  <a href="#af3b33fe7bf17f011bcec0708f8e679f9">More...</a><br /></td></tr>
<tr class="separator:af3b33fe7bf17f011bcec0708f8e679f9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2cd75b991aca30a0bd1df6e2d3a265c2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aaccoder__twoloop_8h.html#a2cd75b991aca30a0bd1df6e2d3a265c2">sclip</a>(x)&#160;&#160;&#160;av_clip(x,60,218)</td></tr>
<tr class="separator:a2cd75b991aca30a0bd1df6e2d3a265c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a393c88eecd9e7d821e9502c96e8a8f4e"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="ffmpeg__filter_8c.html#a61569f2965b7a369eb10b6d75d410d11">int</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aaccoder__twoloop_8h.html#a393c88eecd9e7d821e9502c96e8a8f4e">ff_pns_bits</a> (<a class="el" href="structSingleChannelElement.html">SingleChannelElement</a> *sce, <a class="el" href="ffmpeg__filter_8c.html#a61569f2965b7a369eb10b6d75d410d11">int</a> w, <a class="el" href="ffmpeg__filter_8c.html#a61569f2965b7a369eb10b6d75d410d11">int</a> <a class="el" href="yuv2rgb_8c.html#a73c18c59a39b18382081ec00bb456d43">g</a>)</td></tr>
<tr class="separator:a393c88eecd9e7d821e9502c96e8a8f4e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb6d209421a5b22371165a9ab8eb3301"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="rematrix__template_8c.html#a4dfdfbb7b69470f1152e022432ee2d45">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aaccoder__twoloop_8h.html#aeb6d209421a5b22371165a9ab8eb3301">search_for_quantizers_twoloop</a> (<a class="el" href="structAVCodecContext.html">AVCodecContext</a> *avctx, <a class="el" href="structAACEncContext.html">AACEncContext</a> *<a class="el" href="avxsynth__c_8h.html#ab87f55bd0280d90925050a4188c14ab5">s</a>, <a class="el" href="structSingleChannelElement.html">SingleChannelElement</a> *sce, const float lambda)</td></tr>
<tr class="memdesc:aeb6d209421a5b22371165a9ab8eb3301"><td class="mdescLeft">&#160;</td><td class="mdescRight">two-loop quantizers search taken from ISO 13818-7 Appendix C  <a href="#aeb6d209421a5b22371165a9ab8eb3301">More...</a><br /></td></tr>
<tr class="separator:aeb6d209421a5b22371165a9ab8eb3301"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>AAC encoder twoloop coder. </p>
<dl class="section author"><dt>Author</dt><dd>Konstantin Shishkov, Claudio Freire </dd></dl>

<p>Definition in file <a class="el" href="aaccoder__twoloop_8h_source.html">aaccoder_twoloop.h</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="af3b33fe7bf17f011bcec0708f8e679f9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af3b33fe7bf17f011bcec0708f8e679f9">&sect;&nbsp;</a></span>NOISE_LOW_LIMIT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NOISE_LOW_LIMIT&#160;&#160;&#160;4000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This file contains a template for the twoloop coder function. </p>
<p>It needs to be provided, externally, as an already included declaration, the following functions from aacenc_quantization/util.h. They're not included explicitly here to make it possible to provide alternative implementations:</p><ul>
<li>quantize_band_cost</li>
<li>abs_pow34_v</li>
<li>find_max_val</li>
<li>find_min_book</li>
<li>find_form_factorFrequency in Hz for lower limit of noise substitution </li>
</ul>

<p>Definition at line <a class="el" href="aaccoder__twoloop_8h_source.html#l00054">54</a> of file <a class="el" href="aaccoder__twoloop_8h_source.html">aaccoder_twoloop.h</a>.</p>

<p>Referenced by <a class="el" href="aaccoder_8c_source.html#l00685">mark_pns()</a>, <a class="el" href="aaccoder_8c_source.html#l00543">search_for_pns()</a>, and <a class="el" href="aaccoder__twoloop_8h_source.html#l00067">search_for_quantizers_twoloop()</a>.</p>

</div>
</div>
<a id="a2cd75b991aca30a0bd1df6e2d3a265c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2cd75b991aca30a0bd1df6e2d3a265c2">&sect;&nbsp;</a></span>sclip</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define sclip</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td>&#160;&#160;&#160;av_clip(x,60,218)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="aaccoder__twoloop_8h_source.html#l00056">56</a> of file <a class="el" href="aaccoder__twoloop_8h_source.html">aaccoder_twoloop.h</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a393c88eecd9e7d821e9502c96e8a8f4e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a393c88eecd9e7d821e9502c96e8a8f4e">&sect;&nbsp;</a></span>ff_pns_bits()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="ffmpeg__filter_8c.html#a61569f2965b7a369eb10b6d75d410d11">int</a> ff_pns_bits </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSingleChannelElement.html">SingleChannelElement</a> *&#160;</td>
          <td class="paramname"><em>sce</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ffmpeg__filter_8c.html#a61569f2965b7a369eb10b6d75d410d11">int</a>&#160;</td>
          <td class="paramname"><em>w</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="ffmpeg__filter_8c.html#a61569f2965b7a369eb10b6d75d410d11">int</a>&#160;</td>
          <td class="paramname"><em>g</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="aaccoder__twoloop_8h_source.html#l00059">59</a> of file <a class="el" href="aaccoder__twoloop_8h_source.html">aaccoder_twoloop.h</a>.</p>

<p>Referenced by <a class="el" href="aaccoder__twoloop_8h_source.html#l00067">search_for_quantizers_twoloop()</a>.</p>

</div>
</div>
<a id="aeb6d209421a5b22371165a9ab8eb3301"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeb6d209421a5b22371165a9ab8eb3301">&sect;&nbsp;</a></span>search_for_quantizers_twoloop()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="rematrix__template_8c.html#a4dfdfbb7b69470f1152e022432ee2d45">void</a> search_for_quantizers_twoloop </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structAVCodecContext.html">AVCodecContext</a> *&#160;</td>
          <td class="paramname"><em>avctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAACEncContext.html">AACEncContext</a> *&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structSingleChannelElement.html">SingleChannelElement</a> *&#160;</td>
          <td class="paramname"><em>sce</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float&#160;</td>
          <td class="paramname"><em>lambda</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>two-loop quantizers search taken from ISO 13818-7 Appendix C </p>
<p>rdlambda controls the maximum tolerated distortion. Twoloop will keep iterating until it fails to lower it or it reaches ulimit * rdlambda. Keeping it low increases quality on difficult signals, but lower it too much, and bits will be taken from weak signals, creating "holes". A balance is necessary. rdmax and rdmin specify the relative deviation from rdlambda allowed for tonality compensation</p>
<p>sfoffs controls an offset of optmium allocation that will be applied based on lambda. Keep it real and modest, the loop will take care of the rest, this just accelerates convergence</p>
<p>zeroscale controls a multiplier of the threshold, if band energy is below this, a zero is forced. Keep it lower than 1, unless low lambda is used, because energy &lt; threshold doesn't mean there's no audible signal outright, it's just energy. Also make it rise slower than rdlambda, as rdscale has due compensation with noisy band depriorization below, whereas zeroing logic is rather dumb</p>
<p>Psy granted us extra bits to use, from the reservoire adjust for lambda except what psy already did</p>
<p>Constant Q-scale doesn't compensate MS coding on its own No need to be overly precise, this only controls RD adjustment CB limits when going overboard</p>
<p>When using a constant Q-scale, don't adjust bits, just use RD Don't let it go overboard, though... 8x psy target is enough</p>
<p>Don't offset scalers, just RD</p>
<p>search further</p>
<p>and zero out above cutoff frequency</p>
<p>Scale, psy gives us constant quality, this LP only scales bitrate by lambda, so we save bits on subjectively unimportant HF rather than increase quantization noise. Adjust nominal bitrate to effective bitrate according to encoding parameters, AAC_CUTOFF_FROM_BITRATE is calibrated for effective bitrate.</p>
<p>Compensate for extensions that increase efficiency</p>
<p>for values above this the decoder might end up in an endless loop due to always having more bits than what can be encoded.</p>
<p>XXX: some heuristic to determine initial quantizers will reduce search time determine zero bands and upper distortion limits</p>
<p>Compute initial scalers</p>
<p>log2f-to-distortion ratio is, technically, 2 (1.5db = 4, but it's power vs level so it's 2). But, as offsets are applied, low-frequency signals are too sensitive to the induced distortion, so we make scaling more conservative by choosing a lower log2f-to-distortion ratio, and thus more robust.</p>
<p>Clip</p>
<p>Scale uplims to match rate distortion to quality bu applying noisy band depriorization and tonal band priorization. Maxval-energy ratio gives us an idea of how noisy/tonal the band is. If maxval^2 ~ energy, then that band is mostly noise, and we can relax rate distortion requirements.</p>
<p>psy already priorizes transients to some extent</p>
<p>In ABR, we need to priorize less and let rate control do its thing</p>
<p>In ABR, we need to priorize less and let rate control do its thing</p>
<p>PNS isn't free</p>
<p>Must recompute distortion</p>
<p>PNS isn't free</p>
<p>Start with big steps, end up fine-tunning</p>
<p>Um... over target. Save bits for more important stuff.</p>
<p>SF difference limit violation risk. Must re-clamp.</p>
<p>Scout out next nonzero bands</p>
<p>Make sure proper codebooks are set</p>
<p>Cannot zero out, make sure it's not attempted</p>
<p>Check that there's no SF delta range violations</p>
<p>Set global gain to something useful </p>

<p>Definition at line <a class="el" href="aaccoder__twoloop_8h_source.html#l00067">67</a> of file <a class="el" href="aaccoder__twoloop_8h_source.html">aaccoder_twoloop.h</a>.</p>

<p>Referenced by <a class="el" href="aaccoder__mips_8c_source.html#l02484">ff_aac_coder_init_mips()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Jan 2 2017 22:48:15 for FFmpeg by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
